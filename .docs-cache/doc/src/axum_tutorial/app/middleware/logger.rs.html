<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src\app\middleware\logger.rs`."><title>logger.rs - source</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../..\../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../..\../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../..\../static.files/rustdoc-46132b98.css"><meta name="rustdoc-vars" data-root-path="../../..\../" data-static-root-path="../../..\../static.files/" data-current-crate="axum_tutorial" data-themes="" data-resource-suffix="" data-rustdoc-version="1.85.1 (4eb161250 2025-03-15)" data-channel="1.85.1" data-search-js="search-75f5ac3e.js" data-settings-js="settings-0f613d39.js" ><script src="../../..\../static.files/storage-59e33391.js"></script><script defer src="../../..\../static.files/src-script-56102188.js"></script><script defer src="../../..\../src-files.js"></script><script defer src="../../..\../static.files/main-5f194d8c.js"></script><noscript><link rel="stylesheet" href="../../..\../static.files/noscript-893ab5e7.css"></noscript><link rel="alternate icon" type="image/png" href="../../..\../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../..\../static.files/favicon-044be391.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="src-sidebar-title"><h2>Files</h2></div></nav><div class="sidebar-resizer"></div><main><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1><div class="sub-heading">axum_tutorial\app\middleware/</div>logger.rs</h1><rustdoc-toolbar></rustdoc-toolbar></div><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers">
<a href="#1" id="1">1</a>
<a href="#2" id="2">2</a>
<a href="#3" id="3">3</a>
<a href="#4" id="4">4</a>
<a href="#5" id="5">5</a>
<a href="#6" id="6">6</a>
<a href="#7" id="7">7</a>
<a href="#8" id="8">8</a>
<a href="#9" id="9">9</a>
<a href="#10" id="10">10</a>
<a href="#11" id="11">11</a>
<a href="#12" id="12">12</a>
<a href="#13" id="13">13</a>
<a href="#14" id="14">14</a>
<a href="#15" id="15">15</a>
<a href="#16" id="16">16</a>
<a href="#17" id="17">17</a>
<a href="#18" id="18">18</a>
<a href="#19" id="19">19</a>
<a href="#20" id="20">20</a>
<a href="#21" id="21">21</a>
<a href="#22" id="22">22</a>
<a href="#23" id="23">23</a>
<a href="#24" id="24">24</a>
<a href="#25" id="25">25</a>
<a href="#26" id="26">26</a>
<a href="#27" id="27">27</a>
<a href="#28" id="28">28</a>
<a href="#29" id="29">29</a>
<a href="#30" id="30">30</a>
<a href="#31" id="31">31</a>
<a href="#32" id="32">32</a>
<a href="#33" id="33">33</a>
<a href="#34" id="34">34</a>
<a href="#35" id="35">35</a>
<a href="#36" id="36">36</a>
<a href="#37" id="37">37</a>
<a href="#38" id="38">38</a>
<a href="#39" id="39">39</a>
<a href="#40" id="40">40</a>
<a href="#41" id="41">41</a>
<a href="#42" id="42">42</a>
<a href="#43" id="43">43</a>
<a href="#44" id="44">44</a>
<a href="#45" id="45">45</a>
<a href="#46" id="46">46</a>
<a href="#47" id="47">47</a>
<a href="#48" id="48">48</a>
<a href="#49" id="49">49</a>
<a href="#50" id="50">50</a>
<a href="#51" id="51">51</a>
<a href="#52" id="52">52</a>
<a href="#53" id="53">53</a>
<a href="#54" id="54">54</a>
<a href="#55" id="55">55</a>
<a href="#56" id="56">56</a>
<a href="#57" id="57">57</a>
<a href="#58" id="58">58</a>
<a href="#59" id="59">59</a>
<a href="#60" id="60">60</a>
<a href="#61" id="61">61</a>
<a href="#62" id="62">62</a>
<a href="#63" id="63">63</a>
<a href="#64" id="64">64</a>
<a href="#65" id="65">65</a>
<a href="#66" id="66">66</a>
<a href="#67" id="67">67</a>
<a href="#68" id="68">68</a>
<a href="#69" id="69">69</a>
<a href="#70" id="70">70</a>
<a href="#71" id="71">71</a>
<a href="#72" id="72">72</a>
<a href="#73" id="73">73</a>
<a href="#74" id="74">74</a>
<a href="#75" id="75">75</a>
<a href="#76" id="76">76</a>
<a href="#77" id="77">77</a>
<a href="#78" id="78">78</a>
<a href="#79" id="79">79</a>
<a href="#80" id="80">80</a>
<a href="#81" id="81">81</a>
<a href="#82" id="82">82</a>
<a href="#83" id="83">83</a>
<a href="#84" id="84">84</a>
<a href="#85" id="85">85</a>
<a href="#86" id="86">86</a>
<a href="#87" id="87">87</a>
<a href="#88" id="88">88</a>
<a href="#89" id="89">89</a>
<a href="#90" id="90">90</a>
<a href="#91" id="91">91</a>
<a href="#92" id="92">92</a>
<a href="#93" id="93">93</a>
<a href="#94" id="94">94</a>
<a href="#95" id="95">95</a>
<a href="#96" id="96">96</a>
<a href="#97" id="97">97</a>
<a href="#98" id="98">98</a>
<a href="#99" id="99">99</a>
<a href="#100" id="100">100</a>
<a href="#101" id="101">101</a>
<a href="#102" id="102">102</a>
<a href="#103" id="103">103</a>
<a href="#104" id="104">104</a>
<a href="#105" id="105">105</a>
<a href="#106" id="106">106</a>
<a href="#107" id="107">107</a>
<a href="#108" id="108">108</a>
<a href="#109" id="109">109</a>
<a href="#110" id="110">110</a>
<a href="#111" id="111">111</a>
<a href="#112" id="112">112</a>
<a href="#113" id="113">113</a>
<a href="#114" id="114">114</a>
<a href="#115" id="115">115</a>
<a href="#116" id="116">116</a></pre></div><pre class="rust"><code><span class="comment">// app/middleware/logger.rs
//
// /---------------------------------------------------------------------------------------------------------\
// |                                    【日志中间件模块】 (logger.rs)                                     |
// |---------------------------------------------------------------------------------------------------------|
// |                                                                                                         |
// | 1. **导入依赖**:                                                                                        |
// |    - `tower_http::trace::{self, TraceLayer}`: Tower HTTP 提供的请求跟踪中间件和相关工具。             |
// |    - `tracing::Level`: 定义日志级别 (如 INFO, DEBUG, ERROR)。                                        |
// |    - `tracing_subscriber::{...}`: 用于配置和初始化 `tracing` 日志系统的工具。                         |
// |                                                                                                         |
// | 2. **`setup_logger()` 函数**: 公共函数，用于初始化全局日志系统。                                         |
// |    - **职责**: 配置日志的级别、格式和输出目标。通常在应用启动时调用一次。                               |
// |    - **实现**:                                                                                         |
// |      - `EnvFilter::try_from_default_env()`: 尝试从 `RUST_LOG` 环境变量读取日志过滤指令。             |
// |        例如 `RUST_LOG=info,my_app=debug` 表示默认级别为 INFO，但 `my_app` 模块为 DEBUG。              |
// |      - `.unwrap_or_else(|_| EnvFilter::new("info"))`: 如果环境变量未设置，则默认使用 "info" 级别。  |
// |      - `tracing_subscriber::registry()`: 创建一个订阅者注册表 (registry)。                             |
// |      - `.with(env_filter)`: 将环境过滤器层添加到注册表中。                                           |
// |      - `.with(tracing_subscriber::fmt::layer())`: 添加格式化层，将日志输出到标准输出 (控制台)。      |
// |      - `.init()`: 将构建好的订阅者设置为全局默认日志处理器。                                         |
// |                                                                                                         |
// | 3. **`trace_layer()` 函数**: 公共函数，用于创建并返回一个配置好的 `TraceLayer` 中间件。                   |
// |    - **职责**: 提供一个即插即用的中间件，用于自动记录 HTTP 请求的生命周期事件。                         |
// |    - **返回类型**: `TraceLayer&lt;...&gt;` (具体的分类器类型通常不重要)。                                   |
// |    - **实现**:                                                                                         |
// |      - `TraceLayer::new_for_http()`: 创建一个专门为 HTTP 优化的 `TraceLayer`。                         |
// |      - `.on_request(...)`: 配置当请求开始时记录日志的行为 (默认 INFO 级别)。                         |
// |      - `.on_response(...)`: 配置当响应生成时记录日志的行为 (默认 INFO 级别)。                         |
// |      - `.on_body_chunk(...)`: 配置当处理响应体数据块时的行为 (通常用于调试)。                         |
// |      - `.on_failure(...)`: 配置当请求处理失败时记录日志的行为 (默认 ERROR 级别)。                     |
// |                                                                                                         |
// \---------------------------------------------------------------------------------------------------------/
//
// 【核心职责】: 配置和提供日志记录功能，包括应用程序的全局日志设置和针对 HTTP 请求的详细跟踪中间件。
// 【关键技术】: `tracing` (日志框架), `tracing_subscriber` (日志配置), `tower_http::trace::TraceLayer` (HTTP 请求跟踪中间件), `EnvFilter` (通过环境变量控制日志级别)。

// --- 导入依赖 ---
// `tower_http::trace`: 包含 TraceLayer 中间件和相关的配置助手 (DefaultOnRequest, DefaultOnResponse 等)。
</span><span class="kw">use </span>tower_http::trace::{ <span class="self">self</span>, TraceLayer };
<span class="comment">// `tracing::Level`: 定义不同的日志严重级别 (ERROR, WARN, INFO, DEBUG, TRACE)。
</span><span class="kw">use </span>tracing::Level;
<span class="comment">// `tracing_subscriber`: 用于配置 `tracing` 日志系统的核心库。
// `SubscriberExt`: 扩展 trait，提供 `.with()` 方法来组合不同的日志层 (Layer)。
// `SubscriberInitExt`: 扩展 trait，提供 `.init()` 方法来设置全局日志订阅者。
// `EnvFilter`: 一个日志层，根据环境变量 (通常是 `RUST_LOG`) 来过滤日志事件。
</span><span class="kw">use </span>tracing_subscriber::{ layer::SubscriberExt, util::SubscriberInitExt, EnvFilter };

<span class="doccomment">/// 设置应用程序的全局日志系统 (Function to Setup Application Logging)
///
/// 【功能】: 初始化 `tracing` 日志框架。
///          配置日志事件如何被过滤、格式化和输出。
/// 【调用时机】: 通常在应用程序启动的最开始阶段 (例如 `startup.rs` 的 `init_app` 函数中) 调用一次。
///
/// # 【实现细节】
/// 1. **环境过滤器 (`EnvFilter`)**: [[Tracing 配置: EnvFilter]]
///    - `EnvFilter::try_from_default_env()`: 尝试从环境变量 `RUST_LOG` 中读取过滤指令。
///      这允许开发者在运行时通过设置环境变量来动态调整日志的详细程度，而无需重新编译代码。
///      例如: `RUST_LOG=info` (只显示 INFO 及以上级别), `RUST_LOG=debug` (显示 DEBUG 及以上), `RUST_LOG=axum_tutorial=trace` (只显示本应用的 TRACE 日志)。
///    - `.unwrap_or_else(|_| EnvFilter::new("info"))`: 如果 `RUST_LOG` 环境变量没有设置，则默认使用 `info` 级别过滤。
///      这意味着默认情况下，只有 INFO, WARN, ERROR 级别的日志会被显示。
/// 2. **订阅者构建 (`tracing_subscriber::registry()`)**: [[Tracing 配置: Registry &amp; Layers]]
///    - `registry()`: 创建一个基础的订阅者注册表，用于组合不同的日志处理层。
///    - `.with(env_filter)`: 添加之前创建的环境过滤器层。只有通过这个过滤器的日志事件才会继续向下传递。
///    - `.with(tracing_subscriber::fmt::layer())`: 添加格式化层。
///      `fmt::layer()` 提供了一个标准的日志格式，并将日志输出到标准错误流 (stderr) 或标准输出流 (stdout)。
/// 3. **初始化 (`.init()`)**: [[Tracing 配置: Initialization]]
///    - `.init()`: 将构建好的订阅者设置为【全局默认】日志处理器。
///      一旦设置，应用程序中所有通过 `tracing` 宏 (如 `info!`, `debug!`, `error!`) 发出的日志事件都将被这个订阅者处理。
</span><span class="kw">pub fn </span>setup_logger() {
    <span class="comment">// 创建 EnvFilter，尝试从 RUST_LOG 环境变量读取配置，否则默认为 "info"
    </span><span class="kw">let </span>env_filter = EnvFilter::try_from_default_env().unwrap_or_else(|<span class="kw">_</span>| EnvFilter::new(<span class="string">"info"</span>));

    <span class="comment">// 构建并初始化全局日志订阅者
    </span>tracing_subscriber
        ::registry()
        .with(env_filter) <span class="comment">// 应用环境过滤器
        </span>.with(tracing_subscriber::fmt::layer()) <span class="comment">// 添加标准格式化和输出层
        </span>.init(); <span class="comment">// 设置为全局默认

    // 通过日志系统打印一条信息，确认初始化成功
    </span><span class="macro">tracing::info!</span>(<span class="string">"日志系统已初始化 (默认级别: INFO，可通过 RUST_LOG 环境变量覆盖)"</span>);
}

<span class="doccomment">/// 创建并返回一个用于 HTTP 请求跟踪的 `TraceLayer` 中间件 (Function to Create Trace Middleware)
///
/// 【功能】: 提供一个配置好的 `TraceLayer`，可以作为 Axum 中间件使用。
///          它会自动记录关于传入 HTTP 请求和传出响应的关键信息，如方法、路径、状态码、延迟等。
/// 【用途】: 极大地简化了为 Web 服务添加请求级日志记录的过程。
///
/// # 【返回值】
/// * `-&gt; TraceLayer&lt;...&gt;`: 返回一个 `TraceLayer` 实例。
///                       具体的泛型参数 `SharedClassifier&lt;ServerErrorsAsFailures&gt;` 是 `TraceLayer` 内部使用的请求分类器，
///                       通常我们不需要关心它的具体类型，只需知道它是一个实现了 `Layer` trait 的中间件即可。
</span><span class="kw">pub fn </span>trace_layer() -&gt; TraceLayer&lt;tower_http::classify::SharedClassifier&lt;tower_http::classify::ServerErrorsAsFailures&gt;&gt; {
    <span class="comment">// `TraceLayer::new_for_http()`: 创建一个针对 HTTP 优化的 TraceLayer。
    // 它使用一个默认的分类器，将 HTTP 状态码 4xx 和 5xx 视为失败。
    </span>TraceLayer::new_for_http()
        <span class="comment">// `.on_request(...)`: 配置当请求开始时如何记录日志。[[TraceLayer 配置: on_request]]
        //   - `trace::DefaultOnRequest::new()`: 使用默认的请求日志格式。
        //   - `.level(Level::INFO)`: 将请求开始事件的日志级别设置为 INFO。
        </span>.on_request(trace::DefaultOnRequest::new().level(Level::INFO))
        <span class="comment">// `.on_response(...)`: 配置当响应头准备好时如何记录日志。[[TraceLayer 配置: on_response]]
        //   - `trace::DefaultOnResponse::new()`: 使用默认的响应日志格式，包含状态码和延迟。
        //   - `.level(Level::INFO)`: 将响应事件的日志级别设置为 INFO。
        //   - `.latency_unit(tower_http::LatencyUnit::Micros)`: (可选) 设置延迟单位为微秒。
        </span>.on_response(trace::DefaultOnResponse::new().level(Level::INFO))
        <span class="comment">// `.on_body_chunk(...)`: 配置当处理响应体数据块时如何记录日志 (可选)。[[TraceLayer 配置: on_body_chunk]]
        // 通常在调试流式响应时有用。
        </span>.on_body_chunk(trace::DefaultOnBodyChunk::new())
        <span class="comment">// `.on_failure(...)`: 配置当请求处理过程中发生分类为失败的事件时如何记录日志。[[TraceLayer 配置: on_failure]]
        //   - `trace::DefaultOnFailure::new()`: 使用默认的失败日志格式。
        //   - `.level(Level::ERROR)`: 将失败事件的日志级别设置为 ERROR。
        //     (默认分类器将 5xx 错误视为失败)
        </span>.on_failure(trace::DefaultOnFailure::new().level(Level::ERROR))
}
</code></pre></div></section></main></body></html>