<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axum 任务管理系统</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        h1 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .container {
            display: flex;
            gap: 20px;
        }
        
        .panel {
            flex: 1;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input, textarea, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        #tasksList {
            list-style-type: none;
            padding: 0;
        }
        
        .task-item {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        
        .task-item.completed {
            border-left-color: #2ecc71;
        }
        
        .task-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        /* 新增：编辑模式下的输入框样式 */
        .edit-input {
            width: calc(100% - 18px); /* 减去padding和border */
            margin-bottom: 5px;
        }
        
        #webSocketMessages {
            height: 200px;
            overflow-y: auto;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            font-family: monospace;
            border-radius: 4px;
        }
        
        #wsStatus {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        #wsStatus.connected {
            background-color: #2ecc71;
            color: white;
        }
        
        #wsStatus.disconnected {
            background-color: #e74c3c;
            color: white;
        }
        
        .timestamp {
            color: #95a5a6;
            font-size: 0.8em;
        }
        
        .response-area {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        /* 新增：筛选按钮样式 */
        .filter-btn {
            background-color: #ecf0f1;
            color: #34495e;
            border: 1px solid #bdc3c7;
        }
        
        .filter-btn:hover {
            background-color: #dce4e6;
        }
        
        .filter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* 认证相关样式 */
        .auth-panel {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .auth-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .auth-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-badge.authenticated {
            background-color: #2ecc71;
            color: white;
        }

        .status-badge.unauthenticated {
            background-color: #e74c3c;
            color: white;
        }

        .auth-forms {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .auth-form {
            flex: 1;
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .auth-form h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .auth-message {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .auth-message.success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .auth-message.error {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .auth-message.info {
            background-color: #ebf3fd;
            color: #2980b9;
            border: 1px solid #2980b9;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 页面主标题 -->
    <h1>Axum 任务管理系统 - 前端测试页面</h1>

    <!-- 认证面板 -->
    <div class="auth-panel">
        <div class="auth-status">
            <div class="auth-info">
                <span class="status-badge unauthenticated" id="authStatus">未认证</span>
                <span id="currentUser">未登录</span>
            </div>
            <div>
                <button id="logoutBtn" class="hidden">登出</button>
            </div>
        </div>

        <!-- 认证表单区域 -->
        <div class="auth-forms" id="authForms">
            <!-- 登录表单 -->
            <div class="auth-form">
                <h4>用户登录</h4>
                <form id="loginForm">
                    <input type="text" id="loginUsername" placeholder="用户名" required>
                    <input type="password" id="loginPassword" placeholder="密码" required>
                    <button type="submit">登录</button>
                </form>
                <div id="loginMessage"></div>
            </div>

            <!-- 注册表单 -->
            <div class="auth-form">
                <h4>用户注册</h4>
                <form id="registerForm">
                    <input type="text" id="registerUsername" placeholder="用户名" required>
                    <input type="password" id="registerPassword" placeholder="密码" required>
                    <input type="password" id="confirmPassword" placeholder="确认密码" required>
                    <button type="submit">注册</button>
                </form>
                <div id="registerMessage"></div>
            </div>
        </div>
    </div>

    <!-- 页面主要内容容器，使用 flex 布局 -->
    <div class="container">
        <!-- 左侧面板：任务管理功能区域 -->
        <div class="panel">
            <h2>任务管理</h2>
            
            <!-- 创建任务的表单区域 -->
            <h3>创建新任务</h3>
            <form id="createTaskForm">
                <!-- 任务标题输入框 -->
                <input type="text" id="title" placeholder="任务标题" required>
                <!-- 任务描述文本域 -->
                <textarea id="description" placeholder="任务描述（可选）"></textarea>
                <!-- 任务完成状态复选框 -->
                <label>
                    <input type="checkbox" id="completed">
                    已完成
                </label>
                <!-- 提交表单按钮，用于创建任务 -->
                <button type="submit">创建任务</button>
            </form>
            
            <!-- 刷新任务列表的按钮 -->
            <button id="refreshTasksBtn">刷新任务列表</button>
            
            <!-- 新增：任务筛选按钮 -->
            <div id="filter-buttons" style="margin-top: 10px;">
                <button class="filter-btn active" onclick="setFilter('all')">所有</button>
                <button class="filter-btn" onclick="setFilter('active')">未完成</button>
                <button class="filter-btn" onclick="setFilter('completed')">已完成</button>
            </div>
            
            <!-- 显示任务列表的区域 -->
            <h3>任务列表</h3>
            <ul id="tasksList"></ul>
            
            <!-- 显示 API 响应结果的区域 -->
            <h3>API响应</h3>
            <div id="apiResponse" class="response-area">等待API响应...</div>
        </div>
        
        <!-- 右侧面板：WebSocket 测试功能区域 -->
        <div class="panel">
            <h2>WebSocket测试</h2>
            <!-- 显示 WebSocket 连接状态 -->
            <p>
                状态: <span id="wsStatus" class="disconnected">未连接</span>
                <!-- 连接 WebSocket 按钮 -->
                <button id="wsConnectBtn">连接</button>
                <!-- 断开 WebSocket 按钮，初始状态为禁用 -->
                <button id="wsDisconnectBtn" disabled>断开</button>
            </p>
            
            <!-- 发送 WebSocket 消息的表单 -->
            <form id="wsSendForm">
                <!-- WebSocket 消息输入框 -->
                <input type="text" id="wsMessage" placeholder="输入消息" required>
                <!-- 发送消息按钮，初始状态为禁用 -->
                <button type="submit" disabled>发送</button>
            </form>
            
            <!-- 显示 WebSocket 消息记录的区域 -->
            <h3>消息记录</h3>
            <div id="webSocketMessages"></div>
        </div>
    </div>
    
    <!-- 引入依赖的 JavaScript 文件 -->
    <script src="/js/api-client.js"></script>
    <script src="/js/auth-manager.js"></script>
    <script src="/js/task-manager.js"></script>

    <!-- JavaScript 代码部分 -->
    <script>
        // ==== 全局变量和状态 ====
        // 定义 API 的基础 URL
        const API_BASE_URL = '/api';
        // 根据当前页面地址构建 WebSocket 的 URL
        const WS_URL = `ws://${window.location.host}/ws`;
        // WebSocket 连接对象，初始为 null
        let socket = null;
        // 认证管理器实例
        let authManager = null;
        // API 客户端实例
        let apiClient = null;
        // 任务管理器实例
        let taskManager = null;
        
        // ==== 页面加载时执行 ====
        // 当整个 HTML 文档加载并解析完毕后执行
        document.addEventListener('DOMContentLoaded', async () => {
            // 首先初始化认证管理器
            await initializeAuth();

            // 绑定 WebSocket 相关事件处理器
            document.getElementById('wsConnectBtn').addEventListener('click', connectWebSocket);
            document.getElementById('wsDisconnectBtn').addEventListener('click', disconnectWebSocket);
            document.getElementById('wsSendForm').addEventListener('submit', sendWebSocketMessage);

            // 绑定认证相关事件处理器
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        });
        
        // ==== 认证管理函数 ====

        // 初始化认证管理器
        async function initializeAuth() {
            try {
                // 创建 API 客户端实例
                apiClient = new ApiClient(API_BASE_URL);

                // 创建认证管理器实例
                authManager = new AuthManager({ apiClient });

                // 创建任务管理器实例
                taskManager = new TaskManager({
                    apiClient: apiClient,
                    authManager: authManager,
                    updateApiResponse: updateApiResponse
                });

                // 添加认证事件监听器
                authManager.addEventListener('login', async (data) => {
                    console.log('用户登录成功:', data.user.username);
                    updateAuthUI();
                    showAuthMessage('loginMessage', '登录成功！', 'success');
                    // 登录成功后获取任务列表
                    await taskManager.fetchTasks();
                });

                authManager.addEventListener('logout', () => {
                    console.log('用户已登出');
                    updateAuthUI();
                    showAuthMessage('loginMessage', '已登出', 'info');
                    // 登出后任务管理器会自动处理清空任务列表
                });

                authManager.addEventListener('register', (data) => {
                    console.log('用户注册成功:', data.user.username);
                    showAuthMessage('registerMessage', '注册成功！可以登录了', 'success');
                });

                authManager.addEventListener('loginError', (data) => {
                    console.error('登录失败:', data.error);
                    showAuthMessage('loginMessage', `登录失败: ${data.error}`, 'error');
                });

                authManager.addEventListener('registerError', (data) => {
                    console.error('注册失败:', data.error);
                    showAuthMessage('registerMessage', `注册失败: ${data.error}`, 'error');
                });

                authManager.addEventListener('tokenExpired', () => {
                    console.log('令牌已过期');
                    updateAuthUI();
                    showAuthMessage('loginMessage', '登录已过期，请重新登录', 'error');
                    // 令牌过期后任务管理器会自动处理清空任务列表
                });

                // 初始化任务管理器
                await taskManager.initialize();

                // 初始化 UI 状态
                updateAuthUI();

                console.log('认证管理器和任务管理器初始化完成');

            } catch (error) {
                console.error('系统初始化失败:', error);
                showAuthMessage('loginMessage', '系统初始化失败', 'error');
            }
        }

        // 处理用户登录
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await authManager.login(username, password);
                // 清空登录表单
                document.getElementById('loginForm').reset();
            } catch (error) {
                // 错误已经通过事件处理
                console.error('登录失败:', error.message);
            }
        }

        // 处理用户注册
        async function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            try {
                await authManager.register(username, password, confirmPassword);
                // 清空注册表单
                document.getElementById('registerForm').reset();
            } catch (error) {
                // 错误已经通过事件处理
                console.error('注册失败:', error.message);
            }
        }

        // 处理用户登出
        async function handleLogout() {
            try {
                await authManager.logout();
            } catch (error) {
                console.error('登出失败:', error.message);
            }
        }

        // 更新认证 UI 状态
        function updateAuthUI() {
            const isAuthenticated = authManager ? authManager.isAuthenticated() : false;
            const currentUser = authManager ? authManager.getCurrentUser() : null;

            // 更新认证状态显示
            const statusElement = document.getElementById('authStatus');
            const userElement = document.getElementById('currentUser');
            const logoutBtn = document.getElementById('logoutBtn');
            const authForms = document.getElementById('authForms');

            if (isAuthenticated && currentUser) {
                // 已认证状态
                statusElement.textContent = '已认证';
                statusElement.className = 'status-badge authenticated';
                userElement.textContent = `欢迎，${currentUser.username}`;
                logoutBtn.classList.remove('hidden');
                authForms.classList.add('hidden');
            } else {
                // 未认证状态
                statusElement.textContent = '未认证';
                statusElement.className = 'status-badge unauthenticated';
                userElement.textContent = '未登录';
                logoutBtn.classList.add('hidden');
                authForms.classList.remove('hidden');
            }
        }

        // 显示认证消息
        function showAuthMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="auth-message ${type}">${message}</div>`;

            // 3秒后清除消息
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // ==== 任务管理全局函数（与 TaskManager 集成） ====

        // 这些函数作为全局接口，供 HTML 中的 onclick 事件调用
        // 实际功能由 TaskManager 实例处理

        function viewTask(id) {
            if (taskManager) {
                taskManager.viewTask(id);
            }
        }

        function updateTask(id, payload) {
            if (taskManager) {
                taskManager.updateTask(id, payload);
            }
        }

        function deleteTask(id) {
            if (taskManager) {
                taskManager.deleteTask(id);
            }
        }

        function toggleEditMode(id) {
            if (taskManager) {
                taskManager.toggleEditMode(id);
            }
        }

        function cancelEdit(id) {
            if (taskManager) {
                taskManager.cancelEdit(id);
            }
        }

        function handleSaveTask(id) {
            if (taskManager) {
                taskManager.handleSaveTask(id);
            }
        }

        function confirmDelete(id, title) {
            if (taskManager) {
                taskManager.confirmDelete(id, title);
            }
        }

        function setFilter(filter) {
            if (taskManager) {
                taskManager.setFilter(filter);
            }
        }

        // ==== API 响应显示函数 ====

        // 更新 API 响应显示区域的内容
        function updateApiResponse(action, response, data) {
            // 获取 API 响应显示区域元素
            const responseArea = document.getElementById('apiResponse');
            
            // 获取当前时间作为时间戳
            const timestamp = new Date().toLocaleTimeString();
            // 构建状态文本，如果 response 存在则显示状态码和状态文本，否则显示 'Error'
            let statusText = response ? `${response.status} ${response.statusText}` : 'Error';
            // 将响应数据格式化为易读的 JSON 字符串
            let content = JSON.stringify(data, null, 2);
            
            // 更新显示区域的 HTML 内容
            responseArea.innerHTML = `[${timestamp}] ${action} - ${statusText}\n${content}`;
            // 滚动到底部，显示最新消息
            responseArea.scrollTop = responseArea.scrollHeight;
        }
        
        // ==== WebSocket函数 ====
        
        // 连接 WebSocket 服务器
        function connectWebSocket() {
            // 如果 socket 对象已存在（已连接或正在连接），则不再重复连接
            if (socket !== null) {
                logWebSocketMessage('已经连接到WebSocket服务器');
                return;
            }
            
            try {
                // 创建一个新的 WebSocket 连接
                socket = new WebSocket(WS_URL);
                
                // 监听连接成功事件
                socket.onopen = () => {
                    // 更新 WebSocket 状态显示为已连接
                    updateWebSocketStatus(true);
                    // 记录连接成功的消息
                    logWebSocketMessage('已连接到WebSocket服务器');
                };
                
                // 监听收到消息事件
                socket.onmessage = (event) => {
                    // 记录收到的消息内容
                    logWebSocketMessage(`收到: ${event.data}`);
                };
                
                // 监听连接关闭事件
                socket.onclose = () => {
                    // 更新 WebSocket 状态显示为未连接
                    updateWebSocketStatus(false);
                    // 记录连接关闭的消息
                    logWebSocketMessage('WebSocket连接已关闭');
                    // 将 socket 对象设为 null
                    socket = null;
                };
                
                // 监听连接错误事件
                socket.onerror = (error) => {
                    // 记录错误信息
                    logWebSocketMessage(`WebSocket错误: ${error}`);
                    // 更新 WebSocket 状态显示为未连接
                    updateWebSocketStatus(false);
                };
            } catch (error) {
                // 如果创建 WebSocket 对象时发生错误，打印错误信息到控制台
                console.error('WebSocket连接失败:', error);
                // 记录连接失败的消息
                logWebSocketMessage(`连接失败: ${error.message}`);
            }
        }
        
        // 断开 WebSocket 连接
        function disconnectWebSocket() {
            // 如果 socket 对象为 null，表示未连接，直接返回
            if (socket === null) {
                return;
            }
            
            // 关闭 WebSocket 连接
            socket.close();
            // 连接关闭后，onclose 事件处理器会自动更新 UI
        }
        
        // 发送 WebSocket 消息
        function sendWebSocketMessage(event) {
            // 阻止表单的默认提交行为
            event.preventDefault();
            
            // 如果 socket 对象为 null 或连接未打开，则提示未连接并返回
            if (socket === null || socket.readyState !== WebSocket.OPEN) {
                logWebSocketMessage('未连接到WebSocket服务器');
                return;
            }
            
            // 获取消息输入框元素和消息内容
            const messageInput = document.getElementById('wsMessage');
            const message = messageInput.value;
            
            // 如果消息内容为空白字符，则不发送
            if (message.trim() === '') {
                return;
            }
            
            // 发送消息到 WebSocket 服务器
            socket.send(message);
            // 记录发送的消息
            logWebSocketMessage(`发送: ${message}`);
            // 清空消息输入框
            messageInput.value = '';
        }
        
        // 更新 WebSocket 状态显示和按钮的可用状态
        function updateWebSocketStatus(connected) {
            // 获取状态显示元素、连接按钮、断开按钮和发送按钮
            const statusElem = document.getElementById('wsStatus');
            const connectBtn = document.getElementById('wsConnectBtn');
            const disconnectBtn = document.getElementById('wsDisconnectBtn');
            const sendBtn = document.getElementById('wsSendForm').querySelector('button');
            
            // 根据连接状态更新文本、类名和按钮的禁用状态
            if (connected) {
                statusElem.textContent = '已连接';
                statusElem.className = 'connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
            } else {
                statusElem.textContent = '未连接';
                statusElem.className = 'disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
            }
        }
        
        // 记录 WebSocket 消息到消息记录区域
        function logWebSocketMessage(message) {
            // 获取消息记录区域元素
            const messagesElem = document.getElementById('webSocketMessages');
            // 获取当前时间作为时间戳
            const timestamp = new Date().toLocaleTimeString();
            
            // 创建一个新的 div 元素用于显示消息
            const messageElem = document.createElement('div');
            // 设置消息的 HTML 内容，包含时间戳和消息文本
            messageElem.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            // 将新消息添加到消息记录区域的末尾
            messagesElem.appendChild(messageElem);
            // 滚动到底部，显示最新消息
            messagesElem.scrollTop = messagesElem.scrollHeight;
        }
        



    </script>
</body>
</html>